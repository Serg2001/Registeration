@page "/nextstep-otherteacher"
@rendermode InteractiveServer

@using MudBlazor
@using Registeration.DTOs
@using Registeration.Services
@inject NavigationManager Navigation
@inject IEmailService EmailService
@inject FormStateService FormStateService

<PageTitle>Ուսուցչի Գրանցման Հաստատում</PageTitle>

<MudPaper Class="d-flex flex-column justify-center align-center mt-10 pa-6" Elevation="4" Style="max-width: 600px; margin: auto;">
    <MudText Typo="Typo.h4" Align="Align.Center" GutterBottom="true">
        ✔ Ուսուցիչը հաջողությամբ գրանցվեց
    </MudText>

    <MudText Typo="Typo.subtitle1" Align="Align.Center" Class="mt-2">
        Հաստատման համար մուտք գործեք ձեր նշած էլ․ հասցեն։
    </MudText>

    <MudDivider Class="my-4" />

    <MudButton Variant="Variant.Filled" Color="Color.Primary" Href="/">
        Վերադառնալ Գլխավոր Էջ
    </MudButton>
</MudPaper>

@code {
    protected override async Task OnInitializedAsync()
    {
        var model = FormStateService.OtherTeacherFormModel;

        if (model == null || model.Id == Guid.Empty)
        {
            Console.WriteLine("❌ No OtherTeacherDTO found in FormStateService.");
            return;
        }

        try
        {
            var baseUrl = Navigation.BaseUri.TrimEnd('/');
            var confirmationLink = $"{baseUrl}/confirm-otherteacher?id={model.Id}";

            string emailBody = $@"
                <h3>Բարև Ձեզ, {model.FullName}</h3>
                <p>Շնորհակալություն գրանցման համար։</p>
                <p>Դիտել ձեր գրանցման տվյալները՝ <a href=""{confirmationLink}"">Հաստատման էջ</a></p>";

            Console.WriteLine("📧 Sending to: " + model.Email);
            await EmailService.SendEmailAsync(model.Email, "Ուսուցչի Գրանցման Հաստատում", emailBody);
            Console.WriteLine("✅ Email sent successfully");
        }
        catch (Exception ex)
        {
            Console.WriteLine("❌ Error sending confirmation email: " + ex.Message);
            if (ex.InnerException != null)
                Console.WriteLine("Inner: " + ex.InnerException.Message);
        }
    }
}
