@page "/register"
@using Registeration.DTOs
@using Registeration.Services
@using static Registeration.Responses.CustomResponses
@inject IJSRuntime js
@inject IAccountService accountService

@if (_state == 0)
{
    <EditForm Model="Register" OnValidSubmit="RegisterClicked">
        <DataAnnotationsValidator />
        <ValidationSummary />

        <div class="container">
            <div class="row justify-content-center">
                <div class="col-md-6">
                    <div class="card mt-4">
                        <div class="card-body">
                            <div class="form-group">
                                <label for="socNumber">Սոց. Քարտ</label>
                                <InputText id="socNumber" class="form-control" @bind-Value="Register.SocNumber" />
                                <ValidationMessage For="@(() => Register.SocNumber)" />
                                <small class="form-text text-muted">Min 4, Max. 15 characters</small>
                            </div>

                            <div class="form-group mt-3">
                                <label for="passport">Անձնագիր/Ծննդյան Վկայական</label>
                                <InputText id="passport" class="form-control" @bind-Value="Register.Passport" />
                                <ValidationMessage For="@(() => Register.Passport)" />
                            </div>
                        </div>

                        <div class="card-footer text-end">
                            <button type="submit" class="btn btn-primary">Next</button>
                        </div>
                    </div>

                    <p class="text-center mt-3 text-muted">
                        Լրացրեք բոլոր տվյալները հաջորդ քայլին անցնելու համար:
                    </p>
                </div>
            </div>
        </div>
    </EditForm>
}

@if (_state == 1)
{
    <div class="container mt-4">
        <div class="row">
            <div class="col-md-6 offset-md-3">
                <MudTextField @bind-Value="Surname" Label="Ա․ Ա․ Հ․" ReadOnly="true" Variant="Variant.Filled" />
                <MudTextField @bind-Value="Region" Label="Մարզ" ReadOnly="true" Variant="Variant.Filled" />
                <MudTextField @bind-Value="School" Label="Դպրոց" ReadOnly="true" Variant="Variant.Filled" />
                <MudTextField @bind-Value="Grade" Label="Դասարան" ReadOnly="true" Variant="Variant.Filled" />
                <MudTextField @bind-Value="DateOfBirth" Label="Ծննդյան օր" ReadOnly="true" Variant="Variant.Filled" />

                <div class="d-flex align-center gap-4 mt-4">
                    <MudCheckBox T="bool" Label="I agree!" @bind-Value="isAgreed" Color="Color.Success" />
                    <MudCheckBox T="bool" Label="I disagree!" @bind-Value="isDisagreed" Color="Color.Error" />
                </div>

                <div class="d-flex gap-3 mt-4">
                    <MudButton ButtonType="ButtonType.Submit"
                               Disabled="@(!isAgreed || isDisagreed)"
                               Variant="Variant.Filled"
                               Color="Color.Primary"
                               OnClick="OnNextClicked">
                        NEXT
                    </MudButton>

                    <MudButton ButtonType="ButtonType.Submit"
                               Disabled="@(isAgreed || !isDisagreed)"
                               Variant="Variant.Filled"
                               Color="Color.Primary"
                               OnClick="ContactUs">
                        Contact Us
                    </MudButton>
                </div>
            </div>
        </div>
    </div>
}

@if (_state == 2)
{
    <EditForm Model="Mail" OnValidSubmit="SendEmailVerificationCode">
        <DataAnnotationsValidator />
        <ValidationSummary />

        <div class="form-group mt-3">
            <label for="email">Email Address</label>
            <InputText id="email" class="form-control" @bind-Value="Mail.Email" />
            <ValidationMessage For="@(() => Mail.Email)" />
        </div>

        <button type="submit" class="btn btn-outline-primary mt-2">Send Code</button>
    </EditForm>

    @if (!string.IsNullOrEmpty(VerificationResult))
    {
        <p class="text-success mt-2">@VerificationResult</p>
    }
}

@code {
    public RegisterDTO Register = new();
    public MailDTO Mail = new();
    private int _state = 0;
    private bool isAgreed;
    private bool isDisagreed;
    private string? VerificationResult;

    public string Surname { get; set; } = "Ռոզի Մինասյան";
    public string Region { get; set; } = "Էջմիածին";
    public string School { get; set; } = "Էռռռնեկկյաննն";
    public string Grade { get; set; } = "4-րդ դասարան";
    public string DateOfBirth { get; set; } = "11/05/2006";

    public async Task RegisterClicked()
    {
        try
        {
            var response = await accountService.RegisterAsync(Register);

            if (response is null)
            {
                await js.InvokeVoidAsync("alert", "No response received from the server.");
                return;
            }

            await js.InvokeVoidAsync("alert", $"Response: {response.Message}");

            if (response.Flag)
            {
                Register = new();
                _state = 1;
            }
            else
            {
                await js.InvokeVoidAsync("alert", "Registration failed. Server returned false.");
            }
        }
        catch (Exception ex)
        {
            await js.InvokeVoidAsync("alert", $"Exception: {ex.Message}");
        }
    }

    private void OnNextClicked()
    {
        _state = 2;
    }

    private async Task SendEmailVerificationCode()
    {
        try
        {
            var result = await accountService.SendEmailCodeAsync(Mail.Email);
            VerificationResult = result.Message;
            await js.InvokeVoidAsync("alert", VerificationResult);
        }
        catch (Exception ex)
        {
            await js.InvokeVoidAsync("alert", $"Failed to send code: {ex.Message}");
        }
    }

    private async void ContactUs()
    {
        await js.InvokeVoidAsync("alert", "Please contact us for assistance.");
    }
}
