@page "/register"
@using MailKit
@using Registeration.DTOs
@using Registeration.Data
@using Registeration.Models
@using Registeration.Services
@using System.ComponentModel.DataAnnotations
@using static Registeration.Responses.CustomResponses
@inject IJSRuntime js
@inject IAccountService accountService
@inject IEmailService emailService
@inject IPupilService pupilService

@inject IDialogService DialogService


@if (_state == 0)
{
    <div class="register-container">
        <div class="register-card">
            <EditForm Model="Register" OnValidSubmit="RegisterClicked">
                <DataAnnotationsValidator />
                <ValidationSummary />

                <div class="form-logo text-center">
                    <img src="images/logo.jpg" alt="Logo" class="logo-img-small" />
                </div>

                <div class="form-group">
                    <label for="socNumber">Սոց. Քարտ</label>
                    <InputText id="socNumber" class="form-control" @bind-Value="Register.SocNumber" />
                    <ValidationMessage For="@(() => Register.SocNumber)" />
                </div>

                <div class="form-group mt-3">
                    <label for="passport">Անձնագիր/Ծննդյան Վկայական</label>
                    <InputText id="passport" class="form-control" @bind-Value="Register.Passport" />
                    <ValidationMessage For="@(() => Register.Passport)" />
                </div>

                <div class="text-end mt-4">
                    <button type="submit" class="btn btn-primary">Հաջորդ</button>
                </div>

                <p class="text-center mt-3 text-muted">
                    Լրացրեք բոլոր տվյալները հաջորդ քայլին անցնելու համար:
                </p>
            </EditForm>
        </div>
    </div>
}



@if (_state == 1)
{
    <div class="register-container">
        <div class="register-card">
            <div class="form-logo text-center mb-3">
                <img src="images/logo.jpg" alt="Logo" class="logo-img-small" />
            </div>

            <MudTextField @bind-Value="Pupil.Name" Label="Անուն" ReadOnly="true" Variant="Variant.Filled" />
            <MudTextField @bind-Value="Pupil.SurName" Label="Ազգանուն" ReadOnly="true" Variant="Variant.Filled" />
            <MudTextField @bind-Value="Pupil.MiddleName" Label="Հայրանուն" ReadOnly="true" Variant="Variant.Filled" />
            <MudTextField @bind-Value="Pupil.RegionName" Label="Մարզ" ReadOnly="true" Variant="Variant.Filled" />
            <MudTextField @bind-Value="Pupil.SchoolName" Label="Դպրոց" ReadOnly="true" Variant="Variant.Filled" />
            <MudTextField @bind-Value="Pupil.Grade" Label="Դասարան" ReadOnly="true" Variant="Variant.Filled" />
            <MudTextField @bind-Value="Pupil.Birthday" Label="Ծննդյան օր" ReadOnly="true" Variant="Variant.Filled" />

            <div class="d-flex align-items-center gap-4 mt-4">
                <MudCheckBox T="bool" Label="Համաձայն եմ" @bind-Value="isAgreed" Color="Color.Success" />
                <MudCheckBox T="bool" Label="Համաձայն Չեմ" @bind-Value="isDisagreed" Color="Color.Error" />
            </div>

            <div class="d-flex gap-3 mt-4 justify-content-end">
                <MudButton ButtonType="ButtonType.Submit"
                           Disabled="@(!isAgreed || isDisagreed)"
                           Variant="Variant.Filled"
                           Color="Color.Primary"
                           OnClick="OnNextClicked">
                    Հաջորդ
                </MudButton>

                <MudButton ButtonType="ButtonType.Submit"
                           Disabled="@(isAgreed || !isDisagreed)"
                           Variant="Variant.Outlined"
                           Color="Color.Secondary"
                           OnClick="ContactUs">
                    Կապ Մեզ Հետ
                </MudButton>
            </div>
        </div>
    </div>
}


@if (_state == 2)
{
    <div class="register-container">
        <div class="register-card">
            <div class="form-logo text-center mb-3">
                <img src="images/logo.jpg" alt="Logo" class="logo-img-small" />
            </div>

            <EditForm Model="Mail" OnValidSubmit="SendEmailVerificationCode">
                <DataAnnotationsValidator />
                <ValidationSummary />

                <div class="form-group">
                    <label for="email">Էլ․ Հասցե</label>
                    <InputText id="email" class="form-control" @bind-Value="Mail.Email" />
                    <ValidationMessage For="@(() => Mail.Email)" />
                </div>

                <button type="submit" class="btn btn-primary mt-3 w-100">Ուղարկել Կոդը</button>
            </EditForm>

            @if (!string.IsNullOrEmpty(VerificationResult))
            {
                <p class="text-success mt-3 text-center">@VerificationResult</p>
            }
        </div>
    </div>
}


@if (_state == 3)
{
    <div class="register-container">
        <div class="register-card text-center">
            <div class="form-logo mb-3">
                <img src="images/logo.jpg" alt="Logo" class="logo-img-small" />
            </div>

            <h5 class="mb-3">Մուտքագրեք ձեր էլ․ հասցեին ուղարկված 6-անիշ կոդը</h5>

            <EditForm Model="inputCodeModel" OnValidSubmit="VerifyCode">
                <DataAnnotationsValidator />
                <ValidationSummary />

                <div class="form-group">
                    <InputText id="inputCodeModel" class="form-control code-input" @bind-Value="inputCodeModel.Code" maxlength="6" />
                    <ValidationMessage For="@(() => inputCodeModel.Code)" />
                </div>

                <div class="d-flex gap-3 justify-content-center mt-3">
                    <button type="submit" class="btn btn-success">Ստուգել</button>

                    <button type="button" class="btn btn-outline-secondary" @onclick="SendEmailVerificationCode">
                        Կրկին Ուղարկել
                    </button>
                </div>
            </EditForm>

            @if (!string.IsNullOrEmpty(VerificationResult))
            {
                <p class="text-info mt-3">
                    <i class="fas fa-envelope"></i> @VerificationResult
                </p>
            }
        </div>
    </div>
}



@if (_state == 4)
{
    <div class="register-container">
        <div class="register-card">
            <div class="form-logo text-center mb-3">
                <img src="images/logo.jpg" alt="Logo" class="logo-img-small" />
            </div>

            <h5 class="text-center mb-4">Ստեղծեք Ձեր Էջը</h5>

            <EditForm Model="User" OnValidSubmit="Submit">
                <DataAnnotationsValidator />
                <ValidationSummary />

                <div class="form-group">
                    <label for="username">Օգտատիրոջ Անուն</label>
                    <InputText id="username" class="form-control" @bind-Value="User.UserName" />
                    <ValidationMessage For="@(() => User.UserName)" />
                </div>

                <div class="form-group mt-3">
                    <label for="password">Գաղտնաբառ</label>
                    <InputText id="password" type="password" class="form-control password-input" @bind-Value="User.Password" />
                </div>

                <div class="form-group mt-3">
                    <label for="confirmPassword">Կրկնեք Գաղտնաբառը</label>
                    <InputText id="confirmPassword" type="password" class="form-control password-input" @bind-Value="User.ConfirmPassword" />
                </div>

                <button type="submit" class="btn btn-success mt-4 w-100">Գրանցվել</button>
            </EditForm>
        </div>
    </div>
}


@code {
    public RegisterDTO Register = new();
    public MailDTO Mail = new();
    public UserDTO User = new();
    private PupilInfo Pupil = new();
    private int _state = 0;
    private bool isAgreed;
    private bool isDisagreed;
    private string? VerificationResult;
    public string code;
    private CodeModel inputCodeModel = new();

    public async Task RegisterClicked()
    {
        try
        {
            bool exists = await accountService.SocNumberExistsAsync(Register.SocNumber);

            if (exists)
            {
                VerificationResult = "Այս սոցիալական համարը արդեն գրանցված է։";
                await js.InvokeVoidAsync("alert", VerificationResult);
                return;
            }

            Pupil = await pupilService.GetPupilBySocNumber(Register.SocNumber);

            VerificationResult = null;
            _state = 1; // Move to next registration step
        }
        catch (Exception ex)
        {
            VerificationResult = $"Սխալ տեղի ունեցավ: {ex.Message}";
        }
    }

    private void OnNextClicked()
    {
        _state = 2;
    }

    private async Task SendEmailVerificationCode()
    {
        try
        {
            // Generate random 6-digit code
            code = new Random().Next(100000, 999999).ToString();

            // Build the email body
            string emailBody = $@"
        <h3>DSHH Verification Code</h3>
        <p>Your code is: <strong>{code}</strong></p>
        <p>This code will expire in 5 minutes.</p>";

            // Send the email
            await emailService.SendEmailAsync(Mail.Email, "Your DSHH Verification Code", emailBody);

            VerificationResult = $"📧 Վերիֆիկացիայի կոդը ուղարկվել է {Mail.Email} էլ․ հասցեին";
            _state = 3; // Stay on the same step
        }
        catch (Exception ex)
        {
            VerificationResult = $"❌ Error sending verification code: {ex.Message}";
        }
    }



    private async Task VerifyCode()
    {
        try
        {
            if (string.IsNullOrWhiteSpace(inputCodeModel.Code))
            {
                VerificationResult = "❗ Please enter the code.";
                return;
            }

            if (inputCodeModel.Code == code)
            {
                VerificationResult = "✅ Code verified successfully!";
                _state = 4;
            }
            else
            {
                VerificationResult = "❌ Invalid code. Please try again.";
            }
        }
        catch (Exception ex)
        {
            VerificationResult = $"❌ Error verifying code: {ex.Message}";
        }
    }



    private async Task Submit()
    {
        RegisterationResponse response = await accountService.RegisterAsync(Register, Mail, User);
        if (!response.Flag)
        {
            await js.InvokeVoidAsync("alert", response.Message);
            return;
        }
        await js.InvokeVoidAsync("alert", response.Message);
        return;
    }

    private void ContactUs()
    {
        var options = new DialogOptions { CloseOnEscapeKey = true, MaxWidth = MaxWidth.Small, FullWidth = true };
        DialogService.Show<ContactDialog>("📞 Contact Us", options);
    }



    public class CodeModel
    {
        [Required(ErrorMessage = "Code is required")]
        [StringLength(6, MinimumLength = 6, ErrorMessage = "Code must be exactly 6 digits")]
        [RegularExpression("^[0-9]{6}$", ErrorMessage = "Code must be numeric")]
        public string Code { get; set; } = string.Empty;
    }
}

